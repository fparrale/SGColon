<div class="admin-container">
  <!-- Header with Navigation -->
  <div class="admin-header">
    <div class="admin-header-content">
      <div class="admin-header-title">
        <i class="fas fa-brain"></i>
        <div class="admin-header-text">
          <h1>{{ 'admin.settings.title' | translate }}</h1>
          <p class="admin-header-subtitle">{{ 'admin.settings.subtitle' | translate }}</p>
        </div>
      </div>
      <div class="admin-header-actions">
        <button class="admin-btn-back" (click)="goToDashboard()">
          <i class="fas fa-arrow-left"></i>
          {{ 'admin.common.backToDashboard' | translate }}
        </button>
        <button class="admin-btn-logout admin-btn-danger" (click)="logout()">
          <i class="fas fa-sign-out-alt"></i>
          {{ 'auth.logout' | translate }}
        </button>
      </div>
    </div>

  </div>

  <!-- Loading State -->
  @if (isLoading()) {
  <div class="loading-container">
    <div class="spinner"></div>
    <p>{{ 'admin.settings.loadingSettings' | translate }}</p>
  </div>
  }

  <!-- Settings Content -->
  @if (!isLoading()) {
  <div class="settings-content">

    <!-- Tabs Navigation -->
    <app-tabs [tabs]="tabs" [activeTab]="activeTab()" (tabChange)="onTabChange($event)">
    </app-tabs>

    <!-- TAB 1: INTELIGENCIA ARTIFICIAL -->
    @if (activeTab() === 'ia') {
    <!-- System Prompt Section -->
    <div class="settings-card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-file-text"></i>
          {{ 'admin.settings.systemPrompt' | translate }}
        </h2>
        <p class="card-subtitle">{{ 'admin.settings.systemPromptHelp' | translate }}</p>
      </div>

      <div class="card-body">
        <form [formGroup]="promptConfigForm">
          <div class="form-group">
            <label for="prompt-textarea" class="form-label">
              {{ 'admin.settings.systemPrompt' | translate }}
              <span class="required">*</span>
            </label>
            <p class="form-help">{{ 'admin.settings.systemPromptHelp' | translate }}</p>

            <textarea id="prompt-textarea" class="form-control form-textarea" rows="12" formControlName="promptText"
              [placeholder]="'admin.settings.promptPlaceholder' | translate">
              </textarea>

            <div class="textarea-footer">
              <span class="char-count">{{ promptTextValue.length }} {{ 'admin.settings.characters' | translate
                }}</span>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- AI Provider Selection Section -->
    <div class="settings-card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-server"></i>
          {{ 'admin.settings.aiProvider' | translate }}
        </h2>
        <p class="card-subtitle">{{ 'admin.settings.aiProviderHelp' | translate }}</p>
      </div>

      <div class="card-body">
        <form [formGroup]="promptConfigForm">
          <div class="form-group">
            <label for="provider-select" class="form-label">
              {{ 'admin.settings.aiProvider' | translate }} <span class="required">*</span>
            </label>
            <p class="form-help">
              {{ 'admin.settings.aiProviderHelp' | translate }}
            </p>

            @if (isLoadingProviders()) {
            <div class="loading-small">
              <span class="spinner-small"></span>
              <span>{{ 'admin.settings.loadingProviders' | translate }}</span>
            </div>
            } @else {
            <select id="provider-select" class="form-control form-select" formControlName="preferredProvider">
              @for (provider of availableProviders(); track provider) {
              <option [value]="provider">{{ getProviderLabel(provider) }}</option>
              }
            </select>

            <div class="provider-info-card">
              <div class="provider-icon">
                <i class="fas fa-circle-info"></i>
              </div>
              <div class="provider-description">
                <strong>{{ getProviderLabel(preferredProviderValue) }}</strong>
                <p>{{ getProviderDescription(preferredProviderValue) }}</p>
              </div>
            </div>

            <div class="provider-status-section">
              <p class="provider-status-label">{{ 'admin.settings.availableProviders' | translate }}</p>
              <div class="provider-badges">
                @for (provider of availableProviders(); track provider) {
                @if (provider !== 'auto') {
                <span class="provider-badge" [class.active]="preferredProviderValue === provider">
                  <i class="fas fa-check-circle"></i>
                  {{ getProviderLabel(provider) }}
                </span>
                }
                }
              </div>
            </div>
            }
          </div>

        </form>
      </div>
    </div>

    <!-- Temperature Settings -->
    <div class="settings-card">
      <div class="card-header">
        <h2 class="card-title">
          <i class="fas fa-thermometer-half"></i>
          {{ 'admin.settings.creativity' | translate }}
        </h2>
        <p class="card-subtitle">{{ 'admin.settings.creativityHelp' | translate }}</p>
      </div>

      <div class="card-body">
        <form [formGroup]="promptConfigForm">
          <div class="form-group">
            <label for="temperature-slider" class="form-label">
              {{ 'admin.settings.temperatureLabel' | translate }} <span class="temperature-value">{{
                temperatureValue.toFixed(1) }}</span>
            </label>

            <div class="temperature-info">
              <div class="info-card">
                <span class="info-label">{{ 'admin.settings.level' | translate }}</span>
                <span class="info-value">{{ getTemperatureLabel() }}</span>
              </div>
              <div class="info-card">
                <span class="info-label">{{ 'admin.settings.description' | translate }}</span>
                <span class="info-value">{{ getTemperatureDescription() }}</span>
              </div>
            </div>

            <!-- Slider -->
            <div class="slider-container">
              <span class="slider-label slider-min">
                <i class="fas fa-arrow-left"></i>
                {{ 'admin.settings.precise' | translate }}
              </span>

              <input id="temperature-slider" type="range" min="0" max="1" step="0.1" formControlName="temperature"
                class="form-range">

              <span class="slider-label slider-max">
                {{ 'admin.settings.creative' | translate }}
                <i class="fas fa-arrow-right"></i>
              </span>
            </div>

            <p class="form-help">
              <strong>{{ 'admin.settings.deterministic' | translate }}</strong> {{ 'admin.settings.deterministicDesc'
              |
              translate }}
              <br>
              <strong>{{ 'admin.settings.creativeMax' | translate }}</strong> {{ 'admin.settings.creativeMaxDesc' |
              translate }}
              <br>
              <strong>{{ 'admin.settings.recommended' | translate }}</strong> {{ 'admin.settings.recommendedDesc' |
              translate }}
            </p>
          </div>
        </form>
      </div>
    </div>
    }
    <!-- END TAB 1 -->

    <!-- TAB 2: JUEGO Y CATEGORÍAS -->
    @if (activeTab() === 'juego') {
    <!-- Max Questions Per Game Section -->
    <div class="admin-card">
      <div class="admin-card-header">
        <h2 class="admin-card-title">
          <i class="fas fa-list-ol"></i>
          {{ 'admin.settings.questionsPerGame' | translate }}
        </h2>
        <p class="admin-card-subtitle">{{ 'admin.settings.questionsPerGameHelp' | translate }}</p>
      </div>

      <div class="admin-card-body">
        <form [formGroup]="promptConfigForm">
          <div class="form-group">
            <label for="max-questions-input" class="form-label">
              {{ 'admin.settings.maxQuestionsPerGame' | translate }}
              <span class="required">*</span>
            </label>
            <p class="form-help">
              {{ 'admin.settings.questionsPerGameInfo' | translate }}
              <strong>{{ 'admin.settings.minimum' | translate }} {{ minimumQuestionsRequired }}</strong> {{
              'admin.settings.perCategory' | translate }},
              <strong>{{ 'admin.settings.maximum' | translate }} {{ totalVerifiedQuestions() }}</strong> {{
              'admin.settings.verifiedQuestionsAvailable' | translate }}
            </p>

            <input id="max-questions-input" type="text" class="form-control" formControlName="maxQuestionsPerGame"
              (input)="onMaxQuestionsInput($event)" (blur)="onMaxQuestionsBlur($event)"
              [placeholder]="minimumQuestionsRequired.toString()" inputmode="numeric">

            <div class="input-footer">
              <span class="input-info">
                <i class="fas fa-circle-info"></i>
                {{ 'admin.settings.currentValue' | translate }} <strong>{{ maxQuestionsValue > 0 ? maxQuestionsValue :
                  '-' }}</strong> {{
                maxQuestionsValue > 0 ? ('admin.settings.questions' | translate) : '' }}
              </span>
              <span class="input-info">
                <i class="fas fa-layer-group"></i>
                {{ 'admin.settings.totalCategories' | translate }} <strong>{{ totalCategoriesCount }}</strong>
              </span>
              <span class="input-info">
                <i class="fas fa-check-circle"></i>
                {{ 'admin.settings.verifiedQuestions' | translate }} <strong>{{ totalVerifiedQuestions() }}</strong>
              </span>
            </div>

            <!-- Advertencia si está por debajo del mínimo -->
            @if (maxQuestionsBelowMinimum) {
            <div class="admin-alert admin-alert-danger" style="margin-top: 1rem;">
              <i class="fas fa-exclamation-triangle"></i>
              <div>
                <strong>{{ 'admin.settings.errorBelowMinimum' | translate }}</strong> {{
                'admin.settings.errorBelowMinimumMsg' | translate }} <strong>{{ maxQuestionsValue }}</strong> {{
                'admin.settings.errorBelowMinimumMsg2' | translate }} <strong>{{ minimumQuestionsRequired }}</strong>
                {{
                'admin.settings.errorBelowMinimumMsg3' | translate }}
                {{ 'admin.settings.errorBelowMinimumMsg4' | translate }} <strong>{{ minimumQuestionsRequired
                  }}</strong>
                {{ 'admin.settings.errorBelowMinimumMsg5' | translate }}
              </div>
            </div>
            }

            <!-- Advertencia si excede el disponible -->
            @if (maxQuestionsExceedsAvailable) {
            <div class="admin-alert admin-alert-danger" style="margin-top: 1rem;">
              <i class="fas fa-exclamation-triangle"></i>
              <div>
                <strong>{{ 'admin.settings.errorExceedsAvailable' | translate }}</strong> {{
                'admin.settings.errorExceedsMsg' | translate }} <strong>{{ maxQuestionsValue }}</strong> {{
                'admin.settings.errorExceedsMsg2' | translate }} <strong>{{ totalVerifiedQuestions() }}</strong> {{
                'admin.settings.errorExceedsMsg3' | translate }}
                {{ 'admin.settings.errorExceedsMsg4' | translate }}
              </div>
            </div>
            }

            <!-- Info card sobre distribución -->
            <div class="distribution-info-card">
              <div class="info-icon">
                <i class="fas fa-chart-pie"></i>
              </div>
              <div class="info-content">
                <h4>{{ 'admin.settings.questionDistribution' | translate }}</h4>
                <p>{{ 'admin.settings.questionDistributionDesc' | translate }}</p>
              </div>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- Categories Management Section -->
    <div class="admin-card">
      <div class="admin-card-header">
        <h2 class="admin-card-title">
          <i class="fas fa-folder"></i>
          {{ 'admin.settings.categoryManagement' | translate }}
        </h2>
        <p class="admin-card-subtitle">{{ 'admin.settings.categoryManagementHelp' | translate }}</p>
      </div>

      <div class="admin-card-body">
        <!-- Create Button -->
        <div class="category-actions">
          <button class="admin-btn admin-btn-primary" (click)="openCreateCategoryModal()"
            [disabled]="isLoadingCategories()">
            <i class="fas fa-plus"></i>
            {{ 'admin.settings.newCategory' | translate }}
          </button>
        </div>

        <!-- Loading -->
        @if (isLoadingCategories()) {
        <div class="admin-loading-container admin-loading-container-dark" style="min-height: 100px;">
          <span class="admin-spinner admin-spinner-dark" style="width: 20px; height: 20px;"></span>
          <span>{{ 'admin.settings.loadingCategories' | translate }}</span>
        </div>
        }

        <!-- Categories List -->
        @if (!isLoadingCategories() && categories().length > 0) {
        <div class="categories-list">
          @for (category of categories(); track category.id) {
          <div class="category-item">
            <div class="category-info">
              <div class="category-header">
                <h4 class="category-name">{{ category.name }}</h4>
                <span class="category-id">ID: {{ category.id }}</span>
              </div>
              @if (category.description) {
              <p class="category-description">{{ category.description }}</p>
              }
            </div>
            <div class="action-buttons">
              <button class="btn-action btn-edit" (click)="openEditCategoryModal(category)"
                [disabled]="isDeletingCategory() === category.id" [title]="'admin.settings.editCategory' | translate">
                <i class="fas fa-edit"></i>
              </button>

              <!-- Delete with Confirmation -->
              @if (deleteCategoryConfirmId() !== category.id) {
              <button class="btn-action btn-delete" (click)="deleteCategory(category)"
                [disabled]="isDeletingCategory() === category.id" [title]="'admin.settings.deleteCategory' | translate">
                @if (isDeletingCategory() !== category.id) {
                <i class="fas fa-trash"></i>
                } @else {
                <span class="spinner-small"></span>
                }
              </button>
              } @else {
              <div class="confirm-buttons">
                <button class="btn-confirm confirm-yes" (click)="confirmDeleteCategory(category.id!)"
                  [title]="'admin.settings.confirmDeletion' | translate">
                  <i class="fas fa-check"></i>
                </button>
                <button class="btn-confirm confirm-no" (click)="cancelDeleteCategory()"
                  [title]="'admin.settings.cancel' | translate">
                  <i class="fas fa-times"></i>
                </button>
              </div>
              }
            </div>
          </div>
          }
        </div>
        }

        @if (!isLoadingCategories() && categories().length === 0) {
        <div class="admin-no-data" style="padding: 20px;">
          <i class="fas fa-folder-open"></i>
          <p>{{ 'admin.settings.noCategoriesCreated' | translate }}</p>
        </div>
        }
      </div>
    </div>
    }

    <!-- Action Buttons (OUTSIDE tabs, always visible) -->
    <div class="action-buttons">
      <!-- Discard Changes -->
      @if (hasChanges()) {
      <button class="btn btn-secondary btn-lg" (click)="discardChanges()" [disabled]="isSaving()">
        <i class="fas fa-times"></i>
        {{ 'admin.settings.discardChanges' | translate }}
      </button>
      }

      <!-- Reset to Default -->
      <button class="btn btn-warning btn-lg" (click)="resetToDefault()" [disabled]="isSaving()">
        <i class="fas fa-refresh"></i>
        {{ 'admin.settings.resetToDefault' | translate }}
      </button>

      <!-- Save Changes -->
      <button class="btn btn-primary btn-lg" (click)="saveChanges()" [disabled]="!hasChanges() || isSaving()">
        @if (!isSaving()) {
        <i class="fas fa-save"></i>
        {{ 'admin.settings.saveChanges' | translate }}
        } @else {
        <span class="spinner-small"></span>
        {{ 'admin.settings.saving' | translate }}
        }
      </button>
    </div>

    <!-- Info Section -->
    <div class="info-section">
      <h3 class="info-title">
        <i class="fas fa-circle-info"></i>
        {{ 'admin.settings.importantInfo' | translate }}
      </h3>

      <div class="info-cards">
        <div class="info-item">
          <span class="info-icon">
            <i class="fas fa-lightbulb"></i>
          </span>
          <div class="info-text">
            <h4>{{ 'admin.settings.immediateChanges' | translate }}</h4>
            <p>{{ 'admin.settings.immediateChangesDesc' | translate }}</p>
          </div>
        </div>

        <div class="info-item">
          <span class="info-icon">
            <i class="fas fa-circle-check"></i>
          </span>
          <div class="info-text">
            <h4>{{ 'admin.settings.strictValidation' | translate }}</h4>
            <p>{{ 'admin.settings.strictValidationDesc' | translate }}</p>
          </div>
        </div>

        <div class="info-item">
          <span class="info-icon">
            <i class="fas fa-flask"></i>
          </span>
          <div class="info-text">
            <h4>{{ 'admin.settings.experiment' | translate }}</h4>
            <p>{{ 'admin.settings.experimentDesc' | translate }}</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="settings-footer">
      <p class="footer-text">
        <i class="fas fa-circle-info"></i>
        {{ 'admin.settings.lastUpdate' | translate }}
      </p>
    </div>
  </div>
  }

  <!-- Category Modal -->
  @if (isCategoryModalOpen()) {
  <app-category-modal [categoryToEdit]="categoryToEdit()" (close)="closeCategoryModal()" (saved)="onCategorySaved()">
  </app-category-modal>
  }
</div>