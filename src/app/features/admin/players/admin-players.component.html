<div class="admin-container">
  <!-- Header -->
  <div class="admin-header">
    <div class="admin-header-content">
      <div class="admin-header-title">
        <i class="fas fa-users"></i>
        <div class="admin-header-text">
          <h1>{{ 'admin.players.title' | translate }}</h1>
          <p class="admin-header-subtitle">{{ 'admin.players.subtitle' | translate }}</p>
        </div>
      </div>
      <div class="admin-header-actions">
        <button class="admin-btn-back" (click)="goToDashboard()">
          <i class="fas fa-arrow-left"></i>
          {{ 'admin.common.backToDashboard' | translate }}
        </button>
        <button class="admin-btn-logout admin-btn-danger" (click)="logout()">
          <i class="fas fa-sign-out-alt"></i>
          {{ 'auth.logout' | translate }}
        </button>
      </div>
    </div>
  </div>

  <!-- Tabs Navigation -->
  <app-tabs [tabs]="tabs" [activeTab]="activeTab()" (tabChange)="onTabChange($event)">
  </app-tabs>

  <div class="admin-content">
    <!-- TAB 1: LEADERBOARD -->
    @if (activeTab() === 'leaderboard') {
    <div class="admin-card">
      <div class="admin-card-header">
        <h2 class="admin-card-title">
          <i class="fas fa-trophy"></i>
          {{ 'admin.players.leaderboardTitle' | translate }}
        </h2>
        <p class="admin-card-subtitle">{{ 'admin.players.leaderboardSubtitle' | translate }}</p>
      </div>

      <div class="admin-card-body">
        @if (isLoadingLeaderboard()) {
        <div class="admin-loading-container admin-loading-container-dark" style="min-height: 200px">
          <div class="admin-spinner admin-spinner-dark"></div>
          <p style="color: #7f8c8d">{{ 'admin.players.loadingLeaderboard' | translate }}</p>
        </div>
        } @else {
        <!-- Chart -->
        @if (leaderboardChartData()) {
        <div class="chart-container">
          <canvas baseChart [data]="leaderboardChartData()!" [type]="leaderboardChartType"
            [options]="leaderboardChartOptions">
          </canvas>
        </div>
        }

        <!-- Leaderboard Table -->
        @if (leaderboardData().length > 0) {
        <div class="admin-table-container">
          <table class="admin-table leaderboard-table">
            <thead>
              <tr>
                <th class="rank-col">{{ 'admin.players.rank' | translate }}</th>
                <th class="name-col">{{ 'admin.players.player' | translate }}</th>
                <th class="age-col">{{ 'admin.players.age' | translate }}</th>
                <th class="score-col">{{ 'admin.players.highScore' | translate }}</th>
                <th class="games-col">{{ 'admin.players.games' | translate }}</th>
                <th class="accuracy-col">{{ 'admin.players.accuracy' | translate }}</th>
                <th class="actions-col">{{ 'admin.players.actions' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              @for (entry of leaderboardData(); track entry.player_id) {
              <tr class="leaderboard-row" [class.top-3]="entry.rank <= 3">
                <td class="rank-cell">
                  @if (entry.rank === 1) {
                  <span class="rank-badge gold">
                    <i class="fas fa-crown"></i> #{{ entry.rank }}
                  </span>
                  } @else if (entry.rank === 2) {
                  <span class="rank-badge silver">
                    <i class="fas fa-medal"></i> #{{ entry.rank }}
                  </span>
                  } @else if (entry.rank === 3) {
                  <span class="rank-badge bronze">
                    <i class="fas fa-award"></i> #{{ entry.rank }}
                  </span>
                  } @else {
                  <span class="rank-number">#{{ entry.rank }}</span>
                  }
                </td>
                <td class="name-cell">{{ entry.player_name }}</td>
                <td class="age-cell">{{ entry.age }} {{ 'admin.players.years' | translate }}</td>
                <td class="score-cell">
                  <strong>{{ entry.high_score }}</strong>
                </td>
                <td class="games-cell">{{ entry.total_games }}</td>
                <td class="accuracy-cell">
                  <span class="accuracy-badge" [class.high]="entry.overall_accuracy >= 80">
                    {{ entry.overall_accuracy.toFixed(1) }}%
                  </span>
                </td>
                <td class="actions-cell">
                  <button class="btn-view-profile" (click)="viewPlayerProfile(entry.player_id)"
                    [title]="'admin.players.viewFullProfile' | translate">
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>
        } @else {
        <div class="admin-no-data">
          <i class="fas fa-trophy"></i>
          <p>{{ 'admin.players.noLeaderboardData' | translate }}</p>
        </div>
        }
        }
      </div>
    </div>
    }

    <!-- TAB 2: ALL PLAYERS -->
    @if (activeTab() === 'players') {
    <div class="admin-card">
      <div class="admin-card-header">
        <h2 class="admin-card-title">
          <i class="fas fa-users"></i>
          {{ 'admin.players.allPlayersTitle' | translate }}
        </h2>
        <p class="admin-card-subtitle">{{ 'admin.players.allPlayersSubtitle' | translate }}</p>
      </div>

      <div class="admin-card-body">
        <!-- Search Bar -->
        <div class="search-container">
          <div class="search-input-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" class="search-input" [placeholder]="'admin.players.searchPlaceholder' | translate"
              (input)="onSearchChange($event)" [value]="searchQuery()">
          </div>
          <span class="search-results-count">
            {{ filteredPlayers().length }} {{ 'admin.players.resultsCount' | translate }} {{ allPlayers().length }} {{
            'admin.players.playersLabel' | translate }}
          </span>
        </div>

        @if (isLoadingPlayers()) {
        <div class="admin-loading-container admin-loading-container-dark" style="min-height: 200px">
          <div class="admin-spinner admin-spinner-dark"></div>
          <p style="color: #7f8c8d">{{ 'admin.players.loadingPlayers' | translate }}</p>
        </div>
        } @else {
        @if (filteredPlayers().length > 0) {
        <div class="players-grid">
          @for (player of filteredPlayers(); track player.id) {
          <div class="player-card">
            <div class="player-card-header">
              <div class="player-avatar">
                <i class="fas fa-user"></i>
              </div>
              <div class="player-info">
                <h3 class="player-name">{{ player.name }}</h3>
                <p class="player-meta">
                  <span class="player-id">ID: {{ player.id }}</span>
                  <span class="player-age">{{ player.age }} {{ 'admin.players.years' | translate }}</span>
                </p>
              </div>
            </div>
            <div class="player-card-actions">
              <button class="admin-btn admin-btn-primary" (click)="viewPlayerProfile(player.id)">
                <i class="fas fa-chart-line"></i>
                {{ 'admin.players.viewStats' | translate }}
              </button>
            </div>
          </div>
          }
        </div>
        } @else {
        <div class="admin-no-data">
          <i class="fas fa-search"></i>
          <p>{{ 'admin.players.noPlayersFound' | translate }}</p>
        </div>
        }
        }
      </div>
    </div>
    }

    <!-- TAB 3: PLAYER PROFILE -->
    @if (activeTab() === 'profile') {
    <div class="admin-card">
      <div class="admin-card-header">
        <h2 class="admin-card-title">
          <i class="fas fa-user-circle"></i>
          {{ 'admin.players.playerProfileTitle' | translate }}
        </h2>
        <p class="admin-card-subtitle">{{ 'admin.players.playerProfileSubtitle' | translate }}</p>
      </div>

      <div class="admin-card-body">
        @if (!selectedPlayerId()) {
        <div class="admin-no-data">
          <i class="fas fa-user-slash"></i>
          <p>{{ 'admin.players.noPlayerSelected' | translate }}</p>
        </div>
        } @else if (isLoadingProfile()) {
        <div class="admin-loading-container admin-loading-container-dark" style="min-height: 200px">
          <div class="admin-spinner admin-spinner-dark"></div>
          <p style="color: #7f8c8d">{{ 'admin.players.loadingProfile' | translate }}</p>
        </div>
        } @else if (selectedPlayerStats()) {
        <!-- Clear Button -->
        <div class="profile-actions">
          <button class="btn btn-secondary" (click)="clearPlayerSelection()">
            <i class="fas fa-arrow-left"></i>
            {{ 'admin.players.selectOtherPlayer' | translate }}
          </button>
        </div>

        <!-- Global Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-gamepad"></i>
            </div>
            <div class="stat-content">
              <span class="stat-label">{{ 'admin.players.totalGames' | translate }}</span>
              <span class="stat-value">{{ selectedPlayerStats()!.global!.total_games }}</span>
            </div>
          </div>

          <div class="stat-card highlight">
            <div class="stat-icon">
              <i class="fas fa-star"></i>
            </div>
            <div class="stat-content">
              <span class="stat-label">{{ 'admin.players.highScore' | translate }}</span>
              <span class="stat-value">{{ selectedPlayerStats()!.global!.high_score }}</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-chart-line"></i>
            </div>
            <div class="stat-content">
              <span class="stat-label">{{ 'admin.players.avgScore' | translate }}</span>
              <span class="stat-value">{{ selectedPlayerStats()!.global!.avg_score.toFixed(1) }}</span>
            </div>
          </div>

          <div class="stat-card">
            <div class="stat-icon">
              <i class="fas fa-layer-group"></i>
            </div>
            <div class="stat-content">
              <span class="stat-label">{{ 'admin.players.avgDifficulty' | translate }}</span>
              <span class="stat-value">{{ selectedPlayerStats()!.global!.avg_difficulty.toFixed(2) }}</span>
            </div>
          </div>
        </div>

        <!-- Streaks Section -->
        @if (selectedPlayerStreaks()?.streaks) {
        <div class="streaks-section">
          <h3 class="admin-section-title dark">{{ 'admin.players.streaks.title' | translate }}</h3>
          <div class="streaks-grid">
            <div class="streak-card" [class.active]="selectedPlayerStreaks()!.streaks!.is_on_streak">
              <div class="streak-icon">
                <i class="fas fa-fire"></i>
              </div>
              <div class="streak-content">
                <span class="streak-label">{{ 'admin.players.streaks.current' | translate }}</span>
                <span class="streak-value">{{ selectedPlayerStreaks()!.streaks!.current }}</span>
                @if (selectedPlayerStreaks()!.streaks!.is_on_streak) {
                <span class="streak-badge">{{ 'admin.players.streaks.onFire' | translate }}</span>
                }
              </div>
            </div>

            <div class="streak-card best">
              <div class="streak-icon">
                <i class="fas fa-crown"></i>
              </div>
              <div class="streak-content">
                <span class="streak-label">{{ 'admin.players.streaks.best' | translate }}</span>
                <span class="streak-value">{{ selectedPlayerStreaks()!.streaks!.max }}</span>
              </div>
            </div>
          </div>
        </div>
        } @else if (isLoadingStreaks()) {
        <div class="streaks-section">
          <h3 class="admin-section-title dark">{{ 'admin.players.streaks.title' | translate }}</h3>
          <div class="admin-loading-container admin-loading-container-dark" style="min-height: 80px">
            <div class="admin-spinner admin-spinner-dark"></div>
          </div>
        </div>
        }

        <!-- Radar Chart -->
        @if (profileChartData()) {
        <div class="chart-section">
          <h3 class="admin-section-title dark">{{ 'admin.players.performanceByCategory' | translate }}</h3>
          <div class="chart-container radar-chart">
            <canvas baseChart [data]="profileChartData()!" [type]="profileChartType" [options]="profileChartOptions">
            </canvas>
          </div>
        </div>
        }

        <!-- Topics Table -->
        @if (selectedPlayerStats()!.topics && selectedPlayerStats()!.topics!.length > 0) {
        <div class="topics-section">
          <h3 class="admin-section-title dark">{{ 'admin.players.categoryDetail' | translate }}</h3>
          <table class="admin-table topics-table">
            <thead>
              <tr>
                <th>{{ 'admin.players.category' | translate }}</th>
                <th>{{ 'admin.players.answers' | translate }}</th>
                <th>{{ 'admin.players.accuracy' | translate }}</th>
                <th>{{ 'admin.players.avgTime' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              @for (topic of selectedPlayerStats()!.topics!; track topic.category_id) {
              <tr>
                <td class="category-name">{{ topic.category_name }}</td>
                <td>{{ topic.answers }}</td>
                <td>
                  <span class="accuracy-badge" [class.high]="topic.accuracy >= 80">
                    {{ topic.accuracy.toFixed(1) }}%
                  </span>
                </td>
                <td>{{ topic.avg_time_sec.toFixed(1) }}s</td>
              </tr>
              }
            </tbody>
          </table>
        </div>
        }

        <!-- Player Sessions Section -->
        <div class="sessions-section">
          <h3 class="admin-section-title dark">{{ 'admin.players.sessions.title' | translate }}</h3>

          @if (isLoadingSessions()) {
          <div class="admin-loading-container admin-loading-container-dark" style="min-height: 100px">
            <div class="admin-spinner admin-spinner-dark"></div>
          </div>
          } @else if (playerSessions().length > 0) {
          <div class="sessions-grid">
            @for (session of playerSessions(); track session.session_id) {
            <div class="session-card" [class.selected]="selectedSessionId() === session.session_id"
              (click)="selectSession(session.session_id)">
              <div class="session-card-header">
                <span class="session-id">#{{ session.session_id }}</span>
                <span class="session-status" [ngClass]="getSessionStatusClass(session.status)">
                  {{ 'admin.players.sessions.status.' + session.status | translate }}
                </span>
              </div>
              <div class="session-card-body">
                <div class="session-stat">
                  <i class="fas fa-star"></i>
                  <span>{{ session.score }}</span>
                </div>
                <div class="session-stat">
                  <i class="fas fa-check-circle"></i>
                  <span>{{ session.stats.correct_answers }}/{{ session.stats.total_answers }}</span>
                </div>
                <div class="session-stat">
                  <i class="fas fa-percentage"></i>
                  <span>{{ session.stats.accuracy.toFixed(0) }}%</span>
                </div>
              </div>
              <div class="session-card-footer">
                <span class="session-date">
                  <i class="fas fa-calendar"></i>
                  {{ formatDate(session.started_at) }}
                </span>
                @if (session.room) {
                <span class="session-room">
                  <i class="fas fa-door-open"></i>
                  {{ session.room.name }}
                </span>
                }
              </div>
            </div>
            }
          </div>
          } @else {
          <div class="admin-no-data small">
            <i class="fas fa-history"></i>
            <p>{{ 'admin.players.sessions.noSessions' | translate }}</p>
          </div>
          }
        </div>

        <!-- Session Answers Section -->
        <div class="session-answers-section">
          <h3 class="admin-section-title dark">{{ 'admin.players.sessionAnswers.title' | translate }}</h3>

          <!-- Session ID Input (alternative to clicking a session card) -->
          <div class="session-search-container">
            <div class="session-input-wrapper">
              <i class="fas fa-hashtag"></i>
              <input type="number" class="session-input"
                [placeholder]="'admin.players.sessionAnswers.placeholder' | translate" [value]="sessionIdInput()"
                (input)="onSessionIdChange($event)" (keyup.enter)="loadSessionAnswers()">
            </div>
            <button class="admin-btn admin-btn-primary" (click)="loadSessionAnswers()"
              [disabled]="isLoadingSessionAnswers() || !sessionIdInput()">
              @if (isLoadingSessionAnswers()) {
              <span class="spinner-small"></span>
              } @else {
              <i class="fas fa-search"></i>
              }
              {{ 'admin.players.sessionAnswers.search' | translate }}
            </button>
            <label class="errors-filter-toggle">
              <input type="checkbox" [checked]="showOnlyErrors()" (change)="toggleErrorsFilter()">
              <span>{{ 'admin.players.sessionAnswers.errorsOnly' | translate }}</span>
            </label>
          </div>

          <!-- Session Answers Results -->
          @if (sessionAnswers()) {
          <div class="session-answers-results">
            <!-- Summary -->
            <div class="session-summary">
              <div class="summary-item">
                <span class="summary-label">{{ 'admin.players.sessionAnswers.sessionId' | translate }}</span>
                <span class="summary-value">#{{ sessionAnswers()!.session_id }}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">{{ 'admin.players.sessionAnswers.score' | translate }}</span>
                <span class="summary-value">{{ sessionAnswers()!.score }}</span>
              </div>
              <div class="summary-item correct">
                <span class="summary-label">{{ 'admin.players.sessionAnswers.correct' | translate }}</span>
                <span class="summary-value">{{ sessionAnswers()!.summary!.correct }}</span>
              </div>
              <div class="summary-item incorrect">
                <span class="summary-label">{{ 'admin.players.sessionAnswers.incorrect' | translate }}</span>
                <span class="summary-value">{{ sessionAnswers()!.summary!.incorrect }}</span>
              </div>
              <div class="summary-item">
                <span class="summary-label">{{ 'admin.players.accuracy' | translate }}</span>
                <span class="summary-value">{{ sessionAnswers()!.summary!.accuracy }}%</span>
              </div>
            </div>

            <!-- Answers List -->
            @if (sessionAnswers()!.answers && sessionAnswers()!.answers!.length > 0) {
            <div class="answers-list">
              @for (answer of sessionAnswers()!.answers; track answer.answer_id) {
              <div class="answer-card" [class.correct]="answer.is_correct" [class.incorrect]="!answer.is_correct">
                <div class="answer-header" (click)="toggleAnswerExpand(answer.answer_id)">
                  <div class="answer-status">
                    @if (answer.is_correct) {
                    <i class="fas fa-check-circle"></i>
                    } @else {
                    <i class="fas fa-times-circle"></i>
                    }
                  </div>
                  <div class="answer-question-preview">
                    <span class="question-number">Q{{ answer.question.id }}</span>
                    <span class="question-text">{{ answer.question.statement | slice:0:80 }}{{
                      answer.question.statement.length > 80 ? '...' : '' }}</span>
                  </div>
                  <div class="answer-meta">
                    <span class="answer-time" *ngIf="answer.time_to_answer">{{ answer.time_to_answer.toFixed(1)
                      }}s</span>
                    <span class="difficulty-badge">D{{ answer.question.difficulty }}</span>
                    <i class="fas" [class.fa-chevron-down]="expandedAnswerId() !== answer.answer_id"
                      [class.fa-chevron-up]="expandedAnswerId() === answer.answer_id"></i>
                  </div>
                </div>

                @if (expandedAnswerId() === answer.answer_id) {
                <div class="answer-details">
                  <div class="question-full">
                    <p class="question-statement">{{ answer.question.statement }}</p>
                    <span class="question-category">{{ answer.question.category }}</span>
                  </div>

                  <div class="options-list">
                    @for (option of answer.question.options; track option.id) {
                    <div class="option-item" [class.selected]="option.id === answer.selected_option.id"
                      [class.correct-option]="option.is_correct"
                      [class.wrong-selection]="option.id === answer.selected_option.id && !option.is_correct">
                      <span class="option-marker">
                        @if (option.is_correct) {
                        <i class="fas fa-check"></i>
                        } @else if (option.id === answer.selected_option.id) {
                        <i class="fas fa-times"></i>
                        }
                      </span>
                      <span class="option-text">{{ option.text }}</span>
                    </div>
                    }
                  </div>

                  @if (answer.explanation) {
                  <div class="explanation-box" [class.correct]="answer.is_correct"
                    [class.incorrect]="!answer.is_correct">
                    <i class="fas fa-lightbulb"></i>
                    <p>{{ answer.explanation }}</p>
                  </div>
                  }
                </div>
                }
              </div>
              }
            </div>
            } @else {
            <div class="admin-no-data small">
              <i class="fas fa-inbox"></i>
              <p>{{ 'admin.players.sessionAnswers.noAnswers' | translate }}</p>
            </div>
            }
          </div>
          }
        </div>
        }
      </div>
    </div>
    }
  </div>
</div>